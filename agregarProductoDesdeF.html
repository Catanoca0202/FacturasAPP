<!doctype html>
<html lang="es" class="h-100">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Hugo 0.84.0">
    <title>Crear producto</title>

    <!-- Bootstrap core CSS -->
    <link href="https://facturasapp.com/Publico/google-sheets-resources/css/bootstrap.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="https://facturasapp.com/Publico/google-sheets-resources/css/custom.css" rel="stylesheet">
    <link href="https://facturasapp.com/Publico/google-sheets-resources/css/fontello-codes.css" rel="stylesheet">

    <script>
      const IVA_RECARGO_2025 = {
        '21': '5,20%',
        '10': '1,40%',
        '4': '0,50%',
        '0': '0,00%'
      };

      const TARIFAS_IRPF = [
        { label: 'Selecciona una opción', value: '' },
        { label: '7%', value: '7' },
        { label: '15%', value: '15' },
        { label: '19%', value: '19' }
      ];

      function abrirSoporte() {
        window.open('https://soporte.facturasapp.com/hc/es-es/articles/34324157226907-Canales-de-Atenci%C3%B3n');
      }

      function Back() {
        google.script.run.showNuevaFactura();
      }

      function agregarUltimoProducto(refe) {
        google.script.run.agregarUltimoProducto(refe);
      }

      function showPreProducto() {
        google.script.run.showPreProductos();
      }

      function showMenuPrincipal() {
        google.script.run.showSidebar();
      }

      function mostrarAlerta(mensaje) {
        google.script.run.mostrarAlertaDesdeServidor(mensaje);
      }

      function marcarCampo(id, esError) {
        const campo = document.getElementById(id);
        if (!campo) return;
        campo.style.backgroundColor = esError ? '#FFC7C7' : '';
      }

      function verificarDatosObligatoriosProducto() {
        const camposObligatorios = [
          'codigoReferencia',
          'nombre',
          'tipoProducto',
          'tipoUso',
          'valorUnitario',
          'tipoImpuesto',
          'tarifaImpuesto'
        ];

        let isValid = true;
        camposObligatorios.forEach(id => {
          const campo = document.getElementById(id);
          const valor = campo ? campo.value.trim() : '';
          const valido = Boolean(valor);
          marcarCampo(id, !valido);
          if (!valido) {
            isValid = false;
          }
        });

        const aplicarRecargo = document.getElementById('aplicarRecargo').checked;
        const tipoRetencion = document.getElementById('tipoRetencion').value;
        const tarifaRetencion = document.getElementById('tarifaRetencion').value;
        if (!aplicarRecargo && tipoRetencion === 'IRPF' && !tarifaRetencion) {
          marcarCampo('tarifaRetencion', true);
          isValid = false;
        }

        if (isValid) {
          marcarCampo('tarifaRetencion', false);
        }

        return isValid;
      }

      function submitForm() {
        if (verificarDatosObligatoriosProducto()) {
          const form = document.getElementById('productForm');
          form.dispatchEvent(new Event('submit'));
        } else {
          mostrarAlerta('Por favor complete todos los campos obligatorios.');
        }
      }

      function handleSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        formData.set('aplicarRecargo', document.getElementById('aplicarRecargo').checked);

        const data = {};
        formData.forEach((value, key) => {
          data[key] = value;
        });

        google.script.run.withSuccessHandler(function (response) {
          agregarUltimoProducto(response.refe);
          resetForm();
        }).processForm(data);
      }

      function resetForm() {
        const form = document.getElementById('productForm');
        form.reset();
        ['codigoReferencia','nombre','tipoProducto','tipoUso','valorUnitario','tipoImpuesto','tarifaImpuesto','tarifaRetencion']
          .forEach(id => marcarCampo(id, false));
        document.getElementById('aplicarRecargo').checked = false;
        renderTipoRetencion(false);
        renderTarifaRetencion(false);
        document.getElementById('nombre').focus();
      }

      function obtenerTarifaRecargoActual() {
        const iva = document.getElementById('tarifaImpuesto').value;
        return IVA_RECARGO_2025[iva] || '';
      }

      function renderTipoRetencion(aplicarRecargo) {
        const select = document.getElementById('tipoRetencion');
        select.innerHTML = '';
        if (aplicarRecargo) {
          select.add(new Option('Recargo de equivalencia', 'Recargo de equivalencia'));
          select.value = 'Recargo de equivalencia';
          select.disabled = true;
        } else {
          select.add(new Option('Selecciona una opción', ''));
          select.add(new Option('IRPF', 'IRPF'));
          select.value = '';
          select.disabled = false;
        }
      }

      function renderTarifaRetencion(aplicarRecargo, tarifaRecargo = '') {
        const select = document.getElementById('tarifaRetencion');
        select.innerHTML = '';
        if (aplicarRecargo) {
          if (tarifaRecargo) {
            select.add(new Option(tarifaRecargo, tarifaRecargo));
            select.value = tarifaRecargo;
          } else {
            select.add(new Option('Selecciona una tarifa de IVA primero', ''));
            select.value = '';
          }
          select.disabled = true;
        } else {
          TARIFAS_IRPF.forEach(opcion => select.add(new Option(opcion.label, opcion.value)));
          select.value = '';
          select.disabled = false;
        }
      }

      function onTarifaImpuestoChange() {
        if (document.getElementById('aplicarRecargo').checked) {
          renderTarifaRetencion(true, obtenerTarifaRecargoActual());
        }
      }

      function onToggleRecargo(event) {
        const aplicar = event.target.checked;
        renderTipoRetencion(aplicar);
        renderTarifaRetencion(aplicar, aplicar ? obtenerTarifaRecargoActual() : '');
        if (!aplicar) {
          marcarCampo('tarifaRetencion', false);
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('tarifaImpuesto').addEventListener('change', onTarifaImpuestoChange);
        document.getElementById('aplicarRecargo').addEventListener('change', onToggleRecargo);
        document.getElementById('tipoRetencion').addEventListener('change', () => {
          if (document.getElementById('tipoRetencion').value !== 'IRPF') {
            document.getElementById('tarifaRetencion').value = '';
          }
        });
        renderTipoRetencion(false);
        renderTarifaRetencion(false);
      });
    </script>
  </head>

  <body class="d-flex h-100">
    <div class="assistant-container d-flex w-100 h-100 mx-auto flex-column">
      <header class="mb-auto">
        <div id="logo" class="d-flex justify-content-center bg-primary">
          <img src="https://facturasapp-qa.cenet.ws/Publico/google-sheets-resources/images/logoAssistant.png" alt="">
        </div>

       <div class="mt-4 px-4 gx-0 d-flex justify-content-between align-items-center">
                 <!-- <a href="#"  onclick="showMenuPrincipal()" class="btn btn-outline-secondary btn-fluid"><i class="icon-left"></i> <span>Regresar</span></a> -->

                 <a 
                 onclick="Back()" 
                 href="#" 
                 class="btn btn-outline-secondary btn-sm me-2"
                 style="min-width: 120px;"
               >
                 <i class="icon-left"></i>
                 <span class="ms-1">Regresar</span>
               </a>
               <a
               onclick="abrirSoporte()"
               href="#"
               class="btn btn-outline-secondary btn-sm d-flex align-items-center justify-content-center"
               style="width: 40px; height: 40px;"
               data-bs-toggle="tooltip" 
               data-bs-placement="top" 
               title="Soporte" 
             >
               <i class="icon-info"></i>
             </a>
      
               

       </div>
       <div class="mt-2 px-4 gx-0 d-flex flex-column">
        <h2 class="mt-1">Crear producto desde factura</h2>
    </div>
      </header>

      <main>
        <div class="row py-3 px-4 mt-3 gx-0">
          <div class="col-12 py-4">
            <p>Ingresa la información de tu nuevo producto.</p>
          </div>

          <div class="col-12 px-0">
            <form class="row g-3" onsubmit="handleSubmit(event)" id="productForm">
              <div class="col-12">
                <label for="nombre" class="form-label">Nombre</label>
                <input type="text" class="form-control form-control-lg" id="nombre" name="nombre" required>
              </div>

              <div class="col-6">
                <label for="tipoProducto" class="form-label">Tipo producto</label>
                <select id="tipoProducto" name="tipoProducto" class="form-select form-select-lg" required>
                  <option value="">Selecciona una opción</option>
                  <option value="Bien">Bien</option>
                  <option value="Servicio">Servicio</option>
                </select>
              </div>

              <div class="col-6">
                <label for="tipoUso" class="form-label">Tipo de uso</label>
                <select id="tipoUso" name="tipoUso" class="form-select form-select-lg" required>
                  <option value="">Selecciona una opción</option>
                  <option value="VEN">VEN - Venta</option>
                  <option value="COM">COM - Compra</option>
                  <option value="ALQ">ALQ - Alquiler</option>
                </select>
              </div>

              <div class="col-6">
                <label for="valorUnitario" class="form-label">Valor unitario</label>
                <input type="number" class="form-control form-control-lg" id="valorUnitario" name="valorUnitario" required step=".01">
              </div>

              <div class="col-6">
                <label for="codigoReferencia" class="form-label">Código referencia</label>
                <input type="number" class="form-control form-control-lg" id="codigoReferencia" name="codigoReferencia" required>
              </div>

              <div class="col-6">
                <label for="tipoImpuesto" class="form-label">Tipo de impuesto</label>
                <select id="tipoImpuesto" name="tipoImpuesto" class="form-select form-select-lg" required>
                  <option value="IVA">IVA</option>
                </select>
              </div>

              <div class="col-6">
                <label for="tarifaImpuesto" class="form-label">Tarifa impuesto</label>
                <select id="tarifaImpuesto" name="tarifaImpuesto" class="form-select form-select-lg" required>
                  <option value="">Selecciona una opción</option>
                  <option value="0">0%</option>
                  <option value="4">4%</option>
                  <option value="10">10%</option>
                  <option value="21">21%</option>
                </select>
              </div>

              <div class="col-12">
                <div class="form-check mt-2">
                  <input class="form-check-input" type="checkbox" id="aplicarRecargo" name="aplicarRecargo">
                  <label class="form-check-label" for="aplicarRecargo">
                    Aplicar recargo de equivalencia automático
                  </label>
                </div>
              </div>

              <div class="col-6">
                <label for="tipoRetencion" class="form-label">Tipo retención</label>
                <select id="tipoRetencion" name="tipoRetencion" class="form-select form-select-lg">
                  <option value="">Selecciona una opción</option>
                </select>
              </div>

              <div class="col-6">
                <label for="tarifaRetencion" class="form-label">Tarifa retención</label>
                <select id="tarifaRetencion" name="tarifaRetencion" class="form-select form-select-lg">
                  <option value="">Selecciona una opción</option>
                </select>
              </div>

            </form>
          </div>
        </div>
      </main>


      <footer class="mt-auto">
        <div class="row p-4 gx-0">
          <div class="col-6 pe-1">
            <a href="#" onclick="showMenuPrincipal()" class="btn btn-outline-primary btn-lg w-100 btn-menu">
              <span class="">Inicio</span>
              <i class="icon-24-outlined-other-location-home"style="font-size: 20px;"></i>
            </a>
          </div>
          <div class="col-6 ps-1">
            <a href="#" onclick="submitForm()" class="btn btn-primary btn-lg w-100 btn-menu">
              <span class="">Guardar</span>
              <i class="icon-24-outlined-editor-action-save"style="font-size: 18px;"></i>
            </a>
          </div>
        </div>
      </footer>


    </div>
  </body>
</html>
