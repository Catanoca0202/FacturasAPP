<!doctype html>
<html lang="es" class="h-100">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
  <meta name="generator" content="Hugo 0.84.0">
  <title>Crear producto</title>

  <!-- Bootstrap core CSS -->
  <link href="https://facturasapp.com/Publico/google-sheets-resources/css/bootstrap.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="https://facturasapp.com/Publico/google-sheets-resources/css/custom.css" rel="stylesheet">
  <link href="https://facturasapp.com/Publico/google-sheets-resources/css/fontello-codes.css" rel="stylesheet">

  <script>
    const TARIFAS_IRPF = [
      { label: 'Selecciona una opción', value: '' },
      { label: '7%', value: '7' },
      { label: '15%', value: '15' },
      { label: '19%', value: '19' }
    ];

    function abrirSoporte() {
      window.open('https://soporte.facturasapp.com/hc/es-es/articles/34324157226907-Canales-de-Atenci%C3%B3n');
    }

    function mostrarAlerta(mensaje) {
      google.script.run.mostrarAlertaDesdeServidor(mensaje);
    }

    function marcarCampo(id, esError) {
      const campo = document.getElementById(id);
      if (!campo) return;
      campo.style.backgroundColor = esError ? '#FFC7C7' : '';
    }

    function verificarDatosObligatoriosProducto() {
      const camposObligatorios = [
        'codigoReferencia',
        'nombre',
        'tipoProducto',
        'tipoUso',
        'valorUnitario',
        'tipoImpuesto',
        'tarifaImpuesto'
      ];

      let isValid = true;

      camposObligatorios.forEach(id => {
        const campo = document.getElementById(id);
        const valor = campo ? campo.value.trim() : '';
        const esCampoValido = Boolean(valor);
        marcarCampo(id, !esCampoValido);
        if (!esCampoValido) {
          isValid = false;
        }
      });

      // La tarifa de retención es opcional; se asigna si aplica
      marcarCampo('retenciones', false);

      return isValid;
    }

    function submitForm() {
      if (verificarDatosObligatoriosProducto()) {
        const form = document.getElementById('productForm');
        form.dispatchEvent(new Event('submit'));
      } else {
        mostrarAlerta('Por favor complete todos los campos obligatorios.');
      }
    }

    function handleSubmit(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);

      const data = {};
      formData.forEach((value, key) => {
        data[key] = value;
      });

      google.script.run.withSuccessHandler(function () {
        resetForm();
      }).processForm(data);
    }

    function resetForm() {
      const form = document.getElementById('productForm');
      form.reset();
      ['codigoReferencia', 'nombre', 'tipoProducto', 'tipoUso', 'valorUnitario', 'tipoImpuesto', 'tarifaImpuesto', 'retenciones', 'aplicarRecargo', 'tarifaRecargo']
        .forEach(id => marcarCampo(id, false));
      // Inicializa lista IRPF
      renderTarifaRetencion();
      document.getElementById('nombre').focus();
      updateRecargoAvailability();
    }

    function showPreProducto() {
      google.script.run.showPreProductos();
    }

    function showMenuPrincipal() {
      google.script.run.showSidebar();
    }

    function renderTarifaRetencion() {
      const select = document.getElementById('retenciones');
      select.innerHTML = '';
      TARIFAS_IRPF.forEach(opcion => select.add(new Option(opcion.label, opcion.value)));
      select.value = '';
      select.disabled = false;
    }

    function onTarifaImpuestoChange() {
      const ivaVal = Number(document.getElementById('tarifaImpuesto').value || 0);
      updateTarifaRecargo();
      if (ivaVal === 0) {
        const sel = document.getElementById('retenciones');
        if (sel) sel.value = '';
        marcarCampo('retenciones', false);
      }
    }

    function onTipoProductoChange() {
      const tipoProducto = document.getElementById('tipoProducto');
      if (!tipoProducto) return;
      updateRecargoAvailability();
    }

    const RECARGO_EQ_2025 = { '21': '5,2', '10': '1,4', '4': '0,5', '0': '0' };

    function updateTarifaRecargo() {
      const aplicarRecargo = document.getElementById('aplicarRecargo');
      const tarifaImpuesto = document.getElementById('tarifaImpuesto');
      const tarifaRecargo = document.getElementById('tarifaRecargo');
      if (!aplicarRecargo || !tarifaImpuesto || !tarifaRecargo) return;
      if (!aplicarRecargo.checked) {
        tarifaRecargo.value = '0';
        return;
      }
      const iva = tarifaImpuesto.value || '0';
      tarifaRecargo.value = RECARGO_EQ_2025[iva] || '0';
    }

    function updateRecargoAvailability() {
      const tipoProducto = document.getElementById('tipoProducto');
      const aplicarRecargo = document.getElementById('aplicarRecargo');
      const tarifaRecargo = document.getElementById('tarifaRecargo');
      if (!tipoProducto || !aplicarRecargo || !tarifaRecargo) return;
      const isServicio = (String(tipoProducto.value).toLowerCase() === 'servicio');
      if (!isServicio) {
        aplicarRecargo.checked = false;
        aplicarRecargo.disabled = true;
        tarifaRecargo.value = '0';
        tarifaRecargo.readOnly = true;
        aplicarRecargo.closest('.form-check').style.opacity = '0.6';
        tarifaRecargo.closest('.col-6, .col-12').style.opacity = '0.6';
      } else {
        aplicarRecargo.disabled = false;
        tarifaRecargo.readOnly = true;
        aplicarRecargo.closest('.form-check').style.opacity = '';
        tarifaRecargo.closest('.col-6, .col-12').style.opacity = '';
        updateTarifaRecargo();
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('tarifaImpuesto').addEventListener('change', onTarifaImpuestoChange);
      const tipoProducto = document.getElementById('tipoProducto');
      if (tipoProducto) tipoProducto.addEventListener('change', onTipoProductoChange);
      const aplicarRecargo = document.getElementById('aplicarRecargo');
      if (aplicarRecargo) aplicarRecargo.addEventListener('change', updateTarifaRecargo);
      renderTarifaRetencion();
      updateRecargoAvailability();
    });
  </script>
</head>

<body class="d-flex h-100">
  <div class="assistant-container d-flex w-100 h-100 mx-auto flex-column">
    <header class="mb-auto">
      <div id="logo" class="d-flex justify-content-center bg-primary">
        <img src="https://facturasapp-qa.cenet.ws/Publico/google-sheets-resources/images/logoAssistant.png" alt="">
      </div>

      <div class="mt-4 px-4 gx-0 d-flex justify-content-between align-items-center">
        <a href="#" onclick="showPreProducto()" class="btn btn-outline-secondary btn-sm me-2"
          style="min-width: 120px;"><i class="icon-left"></i> <span>Regresar</span></a>
        <a onclick="abrirSoporte()" href="#"
          class="btn btn-outline-secondary btn-sm d-flex align-items-center justify-content-center"
          style="width: 40px; height: 40px;" data-bs-toggle="tooltip" data-bs-placement="top" title="Soporte"><i
            class="icon-info"></i></a>
      </div>
      <h2 class="mt-4 text-center">Crear producto</h2>
    </header>

    <main>
      <div class="row py-3 px-4 mt-3 gx-0">
        <div class="col-12 py-4">
          <p>Ingresa la información de tu nuevo producto.</p>
        </div>

        <div class="col-12 px-0">
          <form class="row g-3" onsubmit="handleSubmit(event)" id="productForm">
            <div class="col-12">
              <label for="nombre" class="form-label">Nombre</label>
              <input type="text" class="form-control form-control-lg" id="nombre" name="nombre" required>
            </div>

            <div class="col-6">
              <label for="tipoProducto" class="form-label">Tipo producto</label>
              <select id="tipoProducto" name="tipoProducto" class="form-select form-select-lg" required>
                <option value="">Selecciona una opción</option>
                <option value="Bien">Producto</option>
                <option value="Servicio">Servicio</option>
              </select>
            </div>

            <div class="col-6">
              <label for="tipoUso" class="form-label">Tipo de uso</label>
              <select id="tipoUso" name="tipoUso" class="form-select form-select-lg" required>
                <option value="">Selecciona una opción</option>
                <option>Venta</option>
                <option>Compra</option>
              </select>
            </div>

            <div class="col-6">
              <label for="valorUnitario" class="form-label">Valor unitario</label>
              <input type="number" class="form-control form-control-lg" id="valorUnitario" name="valorUnitario" required
                step=".01">
            </div>

            <div class="col-6">
              <label for="codigoReferencia" class="form-label">Código referencia</label>
              <input type="text" class="form-control form-control-lg" id="codigoReferencia" name="codigoReferencia"
                required>
            </div>

            <div class="col-6">
              <label for="tipoImpuesto" class="form-label">Tipo de impuesto</label>
              <select id="tipoImpuesto" name="tipoImpuesto" class="form-select form-select-lg" required>
                <option value="IVA">IVA</option>
              </select>
            </div>

            <div class="col-6">
              <label for="tarifaImpuesto" class="form-label">Tarifa impuesto</label>
              <select id="tarifaImpuesto" name="tarifaImpuesto" class="form-select form-select-lg" required>
                <option value="">Selecciona una opción</option>
                <option value="0">0%</option>
                <option value="4">4%</option>
                <option value="10">10%</option>
                <option value="21">21%</option>
              </select>
            </div>

            <div class="col-12">
              <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" id="aplicarRecargo" name="aplicarRecargo">
                <label class="form-check-label" for="aplicarRecargo">Aplicar recargo de equivalencia</label>
              </div>
            </div>

            <div class="col-6">
              <label for="tarifaRecargo" class="form-label">Tarifa recargo equivalencia</label>
              <input type="text" class="form-control form-control-lg" id="tarifaRecargo" name="tarifaRecargo" value="0"
                readonly>
            </div>

            <div class="col-6">
              <label for="retenciones" class="form-label">Tarifa retención</label>
              <select id="retenciones" name="retenciones" class="form-select form-select-lg">
                <option value="">Selecciona una opción</option>
              </select>
            </div>

          </form>
        </div>
      </div>
    </main>


    <footer class="mt-auto">
      <div class="row p-4 gx-0">
        <div class="col-6 pe-1">
          <a href="#" onclick="showMenuPrincipal()" class="btn btn-outline-primary btn-lg w-100 btn-menu">
            <span class="">Inicio</span>
            <i class="icon-24-outlined-other-location-home" style="font-size: 20px;"></i>
          </a>
        </div>
        <div class="col-6 ps-1">
          <a href="#" onclick="submitForm()" class="btn btn-primary btn-lg w-100 btn-menu">
            <span class="">Guardar</span>
            <i class="icon-24-outlined-editor-action-save" style="font-size: 18px;"></i>
          </a>
        </div>
      </div>
    </footer>


  </div>
</body>

</html>